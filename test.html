<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Analysis by Genre</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tooltip {
            pointer-events: none;
        }
        .text-wrap {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Année: <span id="yearValue" class="ml-2"></span>
                    </label>
                    <input type="range" id="yearSlider" 
                           class="w-full h-2 rounded-lg cursor-pointer">
                </div>
                
                <div>
                    <label for="continentSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                        Continent
                    </label>
                    <select id="continentSelect" class="w-full rounded-md border border-gray-300 p-2">
                    </select>
                </div>
                
                <div>
                    <label for="typeSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                        Type
                    </label>
                    <select id="typeSelect" class="w-full rounded-md border border-gray-300 p-2">
                    </select>
                </div>
            </div>

            <div id="visualization-genre" class="mt-4 overflow-auto"></div>

            <h4 class="text-center font-bold mb-8 text-gray-800">Répartition du contenu par genre</h4>
        </div>
    
    </div>

    <script>
        const width = 960;
        const height = 600;
        const margin = { top: 20, right: 10, bottom: 20, left: 10 };

        const svg = d3.select('#visualization-genre')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        const treemap = d3.treemap()
            .size([width - margin.left - margin.right, height - margin.top - margin.bottom])
            .padding(2);

        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        d3.csv('data/cleaned_datasets/streaming_data.csv').then(function(data) {
            data.forEach(d => {
                d.year_added = +d.year_added;
                d.duration_num = +d.duration_num;
            });

            const years = [...new Set(data.map(d => d.year_added))].sort();
            const continents = ['All', ...new Set(data.map(d => d.continent))];
            const types = ['All', ...new Set(data.map(d => d.type))];

            setupFilters(years, continents, types);
            updateVisualization(data);

            document.getElementById('yearSlider').addEventListener('input', () => updateVisualization(data));
            document.getElementById('continentSelect').addEventListener('change', () => updateVisualization(data));
            document.getElementById('typeSelect').addEventListener('change', () => updateVisualization(data));
        });

        function setupFilters(years, continents, types) {
            const yearSlider = document.getElementById('yearSlider');
            yearSlider.min = Math.min(...years);
            yearSlider.max = Math.max(...years);
            yearSlider.value = yearSlider.min;
            document.getElementById('yearValue').textContent = yearSlider.value;

            const continentSelect = document.getElementById('continentSelect');
            continentSelect.innerHTML = continents.map(c => 
                `<option value="${c}">${c}</option>`).join('');

            const typeSelect = document.getElementById('typeSelect');
            typeSelect.innerHTML = types.map(t => 
                `<option value="${t}">${t}</option>`).join('');
        }

        function updateVisualization(data) {
            const yearValue = document.getElementById('yearSlider').value;
            const continentValue = document.getElementById('continentSelect').value;
            const typeValue = document.getElementById('typeSelect').value;
            document.getElementById('yearValue').textContent = yearValue;

            const filtered = data.filter(d => {
                return d.year_added == yearValue &&
                    (continentValue === 'All' || d.continent === continentValue) &&
                    (typeValue === 'All' || d.type === typeValue);
            });

            const genreGroups = d3.group(filtered, d => d.genre);
            let hierarchyData = {
                children: Array.from(genreGroups, ([genre, items]) => ({
                    genre,
                    value: items.length,
                    items
                }))
            };

            hierarchyData.children.sort((a, b) => b.value - a.value);
            hierarchyData.children = hierarchyData.children.slice(0, 25);

            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value);

            treemap(root);

            const nodes = svg.selectAll('g')
                .data(root.leaves(), d => d.data.genre);

            nodes.exit().remove();

            const nodesEnter = nodes.enter()
                .append('g');

            nodesEnter.append('rect');
            nodesEnter.append('text');

            const nodesUpdate = nodes.merge(nodesEnter)
                .transition()
                .duration(750)
                .attr('transform', d => `translate(${d.x0},${d.y0})`);

            nodesUpdate.select('rect')
                .attr('width', d => d.x1 - d.x0)
                .attr('height', d => d.y1 - d.y0)
                .style('fill', d => colorScale(d.data.genre));

            nodesUpdate.select('text')
                .attr('x', 5)
                .attr('y', 20)
                .text(d => `${d.data.genre} (${d.data.value})`)
                .attr('class', 'text-wrap')
                .style('font-size', '6px')
                .style('fill', 'white');

            const allNodes = svg.selectAll('g');
            allNodes.selectAll('rect')
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
        }

        function showTooltip(event, d) {
            const platformCounts = d3.rollup(d.data.items, v => v.length, d => d.platform);
            let content = `<div class="bg-white p-3 rounded shadow-lg border border-gray-200">
                <p class="font-bold mb-2">${d.data.genre}</p>`;
            for (const [platform, count] of platformCounts) {
                content += `<p>${platform}: ${count}</p>`;
            }
            content += `<p class="font-bold mt-2">Total: ${d.data.value}</p></div>`;
            d3.select('body').append('div')
                .attr('class', 'tooltip absolute z-50')
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .html(content);
        }

        function hideTooltip() {
            d3.selectAll('.tooltip').remove();
        }
    </script>
</body>
</html>
